# Smart Contract Security Audit Report

**Project**: Thurin Protocol
**Repository**: https://github.com/benwoodall/thurin
**Auditor**: Claude (AI-Assisted Audit)
**Date**: 2026-01-20
**Review Type**: Fresh Manual Audit

---

## Executive Summary

### Scope

| Item | Details |
|------|---------|
| Contracts | ThurinSBT.sol, ThurinVerifier.sol, ThurinPoints.sol, IHonkVerifier.sol |
| Lines of Code | ~677 LOC (excluding HonkVerifier which is auto-generated) |
| Solidity Version | 0.8.28 |
| Framework | Foundry |
| Chain Target | Ethereum mainnet, Sepolia testnet |

### Findings Summary

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 0 |
| Medium | 2 |
| Low | 4 |
| Informational | 3 |
| **Total** | **9** |

### Overall Assessment

The Thurin Protocol demonstrates solid security practices. The contracts are well-structured with appropriate use of OpenZeppelin libraries (Ownable2Step, ERC721, Base64, Strings) and include comprehensive test coverage (82+ tests passing, including fuzz tests).

**Key Strengths:**
- Two-step ownership transfer (Ownable2Step) prevents accidental ownership loss
- Soulbound token implementation correctly prevents transfers via `_update()` override
- Nullifier-based sybil resistance for mint operations
- Minimum validity period enforcement (`MIN_VALIDITY_PERIOD`)
- Events emitted for all admin parameter changes
- Renewal functionality allows users to extend SBT validity
- Clean on-chain SVG generation with no injection vectors
- Custom errors for gas efficiency
- Privacy-preserving verification (no events in ThurinVerifier)

**Areas Requiring Attention:**
- `getTopDapps()` function has DoS risk with unbounded iteration
- Missing zero-address validation in constructors

---

## Findings

### [M-01] DoS Risk in getTopDapps - MEDIUM

**Location**: `src/ThurinPoints.sol:153-186`

**Description**: The `getTopDapps` function uses an O(n*limit) selection sort algorithm with external calls in a nested loop. As registered dApps grow, this will exceed block gas limits.

```solidity
for (uint256 i = 0; i < limit; i++) {
    for (uint256 j = 0; j < count; j++) {
        if (!used[j]) {
            uint256 val = verifier.dappVerificationCount(registeredDapps[j]); // External call per iteration
            // ...
        }
    }
}
```

**Impact**: With hundreds of registered dApps, this view function becomes unusable. While view functions don't cost gas for off-chain calls, frontends and on-chain integrations may fail.

**Recommendation**: Implement pagination or move leaderboard functionality off-chain:

```solidity
function getTopDapps(uint256 offset, uint256 limit) external view returns (
    address[] memory dapps,
    uint256[] memory verifications,
    bool hasMore
);
```

---

### [M-02] Missing Zero-Address Validation in Constructors - MEDIUM

**Locations**:
- `src/ThurinSBT.sol:80-82`
- `src/ThurinVerifier.sol:25-28`
- `src/ThurinPoints.sol:37-40`

**Description**: Constructors do not validate that provided addresses are non-zero. Since these are stored as immutable variables, deployment errors require full redeployment.

```solidity
constructor(address _honkVerifier) ERC721("Thurin SBT", "THURIN") Ownable(msg.sender) {
    honkVerifier = IHonkVerifier(_honkVerifier);  // No zero-check
}
```

**Recommendation**:

```solidity
constructor(address _honkVerifier) {
    require(_honkVerifier != address(0), "Zero address");
    honkVerifier = IHonkVerifier(_honkVerifier);
}
```

---

### [L-01] setMintPrice / setRenewalPrice Allow Zero - LOW

**Location**: `src/ThurinSBT.sol:351-362`

**Description**: Owner can set mint and renewal prices to zero, potentially enabling spam or undermining revenue.

**Recommendation**: Add minimum price validation or document that zero is intentional for promotional periods.

---

### [L-02] No Event on withdraw() - LOW

**Location**: `src/ThurinSBT.sol:373-376`

**Description**: The `withdraw()` function does not emit an event, making fund tracking harder.

**Recommendation**:

```solidity
event Withdrawn(address indexed to, uint256 amount);

function withdraw() external onlyOwner {
    uint256 amount = address(this).balance;
    (bool success,) = payable(owner()).call{value: amount}("");
    if (!success) revert WithdrawFailed();
    emit Withdrawn(owner(), amount);
}
```

---

### [L-03] Excess ETH Not Refunded - LOW

**Locations**: `src/ThurinSBT.sol:132, 290`

**Description**: Users who overpay for mint or renewal lose the excess ETH. The check `msg.value < getMintPrice()` allows any amount above the minimum.

**Recommendation**: Either refund excess or use exact payment check:

```solidity
if (msg.value != getMintPrice()) revert IncorrectPayment();
```

---

### [L-04] Unbounded registeredDapps Array - LOW

**Location**: `src/ThurinPoints.sol:29, 116`

**Description**: The `registeredDapps` array can grow without limit, exacerbating the `getTopDapps()` gas issue.

**Recommendation**: Consider adding a registration limit or implementing a registration fee to discourage spam.

---

### [I-01] Centralization Risks - INFORMATIONAL

**Description**: Single owner controls critical functions:
- Add/remove IACA roots (could invalidate all verification)
- Set prices (could enable free mints)
- Set validity periods
- Withdraw all funds

**Recommendation**: Use a multisig wallet and consider timelocks for sensitive operations.

---

### [I-02] Renewal Nullifier Design Note - INFORMATIONAL

**Location**: `src/ThurinSBT.sol:299`

**Description**: The `renew()` function intentionally allows the same nullifier for renewal (documented in code). This is a design decision that enables legitimate renewal but technically allows a different mDL to be used for renewal.

**Note**: This is acceptable given the threat model - the original SBT holder still controls the wallet, and renewal requires a valid ZK proof.

---

### [I-03] Block Timestamp Dependency - INFORMATIONAL

**Locations**: `src/ThurinSBT.sol:135-136`, `src/ThurinVerifier.sol:59-60`

**Description**: Proof freshness relies on `block.timestamp` which miners can manipulate ~15 seconds. The 1-hour validity window provides adequate margin.

**Status**: Acceptable risk given the generous validity period.

---

## New Code Review: tokenURI() with On-Chain SVG

**Location**: `src/ThurinSBT.sol:213-262`

**Added Components**:
- Import: `Base64` from OpenZeppelin
- Import: `Strings` from OpenZeppelin
- New function: `tokenURI()` override

**Security Analysis**:

| Check | Status | Notes |
|-------|--------|-------|
| OpenZeppelin libraries | SAFE | Uses audited Base64 and Strings |
| User input in SVG | SAFE | No user input - only internal state (tokenId, tier) |
| Ownership validation | PRESENT | `_requireOwned(tokenId)` called first |
| Gas cost | OK | View function, no on-chain gas for reads |
| SVG injection | SAFE | Hardcoded paths, colors derived from enum |

**Code Review**:

```solidity
function tokenURI(uint256 tokenId) public view override returns (string memory) {
    _requireOwned(tokenId);  // Validates token exists

    // Color selection from internal enum - no injection risk
    string memory checkColor;
    Tier tier = tokenTier[tokenId];
    if (tier == Tier.OG) {
        checkColor = "#b76e79"; // Hardcoded
    } // ...

    // SVG built from hardcoded strings + internal state only
    string memory svg = string(abi.encodePacked(
        '<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">',
        // ... hardcoded paths ...
        checkColor,  // From internal enum lookup
        // ...
    ));

    // JSON + Base64 encoding using OpenZeppelin
    return string(abi.encodePacked("data:application/json;base64,", Base64.encode(bytes(json))));
}
```

**Verdict**: NO SECURITY ISSUES FOUND with the tokenURI implementation.

---

## Positive Observations

| Feature | Implementation | Status |
|---------|---------------|--------|
| Ownership Transfer | Ownable2Step | Correct |
| Soulbound Enforcement | `_update()` override | Correct |
| Sybil Resistance | Nullifier tracking | Correct |
| Validity Period | MIN_VALIDITY_PERIOD = 1 day | Correct |
| Admin Events | MintPriceUpdated, RenewalPriceUpdated, ValidityPeriodUpdated | Present |
| Renewal Mechanism | `renew()` function with fresh proof | Present |
| On-chain Metadata | tokenURI with SVG | Safe |
| Custom Errors | All error conditions | Gas efficient |
| Test Coverage | 82+ tests including fuzz | Comprehensive |

---

## Recommendations Summary

| Priority | Action |
|----------|--------|
| High | Add zero-address validation in constructors |
| High | Implement pagination for `getTopDapps()` or move off-chain |
| Medium | Add event emission on `withdraw()` |
| Medium | Consider refunding excess ETH payments |
| Low | Add minimum price validation |
| Low | Use multisig wallet as owner for production |
| Low | Consider timelock for IACA root changes |

---

## Appendix

### Test Results

```
Ran test suites: 82+ tests passed, 0 failed, 0 skipped
```

### Files Reviewed

| File | LOC | Last Modified |
|------|-----|---------------|
| src/ThurinSBT.sol | 377 | 2026-01-20 |
| src/ThurinVerifier.sol | 97 | 2026-01-20 |
| src/ThurinPoints.sol | 188 | 2026-01-20 |
| src/interfaces/IHonkVerifier.sol | 15 | 2026-01-20 |

### Disclosure

This audit was performed by Claude, an AI assistant, with direct file system access to ensure fresh context. While comprehensive manual analysis was performed, AI-assisted audits should be supplemented with human expert review for critical deployments. Consider engaging a professional auditing firm before mainnet deployment, especially for ZK circuit security review.

---

*Generated by Fresh Manual Audit on 2026-01-20*
